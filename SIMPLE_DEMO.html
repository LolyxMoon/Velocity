<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VelocityBets - Simple Demo</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .network-badge {
            display: inline-block;
            padding: 8px 16px;
            background: #3498db;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        .wallet-section {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn:hover { transform: scale(1.05); }
        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .market-card {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .market-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }
        .gauge {
            text-align: center;
            margin: 20px 0;
        }
        .gauge-value {
            font-size: 3em;
            font-weight: bold;
            color: #f39c12;
        }
        .bet-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        .bet-yes {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            padding: 20px;
            border-radius: 15px;
            border: none;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .bet-no {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            padding: 20px;
            border-radius: 15px;
            border: none;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .bet-yes:hover, .bet-no:hover { transform: scale(1.05); }
        .bet-yes:disabled, .bet-no:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .bet-label {
            display: block;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .bet-payout {
            display: block;
            font-size: 0.9em;
            opacity: 0.9;
        }
        .odds-bars {
            margin: 30px 0;
        }
        .odds-row {
            margin: 15px 0;
        }
        .odds-label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .bar {
            background: rgba(255,255,255,0.1);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        .bar-fill {
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-weight: bold;
        }
        .bar-fill.yes {
            background: linear-gradient(90deg, #f39c12, #e67e22);
        }
        .bar-fill.no {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
        .info-box {
            background: rgba(52, 152, 219, 0.2);
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .live-indicator {
            text-align: center;
            margin-top: 20px;
            opacity: 0.7;
            font-size: 0.9em;
        }
        .live-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #2ecc71;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .input-group {
            margin: 20px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
        }
        .input-group input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🚀 VelocityBets Demo</h1>
            <p>Simple Prediction Market Demo</p>
            <div class="network-badge" id="networkBadge">Not Connected</div>
        </div>

        <!-- Info Box -->
        <div class="info-box">
            <strong>📚 For Web Developers:</strong><br>
            This is a simple demo showing how to interact with the prediction market smart contracts.
            <br><br>
            <strong>Current Mode:</strong> <span id="modeText">BSC Testnet (Safe to experiment!)</span>
            <br>
            <strong>Get Test BNB:</strong> <a href="https://testnet.bnbchain.org/faucet-smart" target="_blank" style="color: #3498db">BSC Testnet Faucet</a>
        </div>

        <!-- Wallet Connection -->
        <div class="wallet-section">
            <button class="btn" id="connectBtn" onclick="connectWallet()">
                Connect Wallet
            </button>
            <div id="walletInfo" style="margin-top: 15px; display: none;">
                <div style="font-size: 0.9em; opacity: 0.8;">Connected:</div>
                <div id="walletAddress" style="font-family: monospace; margin-top: 5px;"></div>
                <div id="walletBalance" style="margin-top: 5px; color: #f39c12;"></div>
            </div>
        </div>

        <!-- Market Card -->
        <div class="market-card">
            <div class="market-title">Will 哈基米 reach $100M mcap before October 30?</div>
            
            <!-- Gauge -->
            <div class="gauge">
                <div class="gauge-value" id="yesPercentage">---%</div>
                <div style="opacity: 0.7; margin-top: 5px;">Chance of YES</div>
            </div>

            <!-- Bet Amount Input -->
            <div class="input-group">
                <label for="betAmount">Bet Amount (BNB):</label>
                <input type="number" id="betAmount" value="0.01" step="0.01" min="0.001" max="0.1">
                <div style="font-size: 0.8em; opacity: 0.7; margin-top: 5px;">
                    Max: 0.1 BNB per wallet
                </div>
            </div>

            <!-- Bet Buttons -->
            <div class="bet-buttons">
                <button class="bet-yes" id="betYesBtn" onclick="placeBet(true)" disabled>
                    <span class="bet-label">Yes</span>
                    <span class="bet-payout" id="yesPayout">-- BNB → -- BNB</span>
                </button>
                <button class="bet-no" id="betNoBtn" onclick="placeBet(false)" disabled>
                    <span class="bet-label">No</span>
                    <span class="bet-payout" id="noPayout">-- BNB → -- BNB</span>
                </button>
            </div>

            <!-- Odds Bars -->
            <div class="odds-bars">
                <div class="odds-row">
                    <span class="odds-label" id="yesLabel">--% Chance</span>
                    <div class="bar">
                        <div class="bar-fill yes" id="yesBar" style="width: 50%">
                            <span id="yesPool">-- BNB</span>
                        </div>
                    </div>
                </div>
                <div class="odds-row">
                    <span class="odds-label" id="noLabel">--% Chance</span>
                    <div class="bar">
                        <div class="bar-fill no" id="noBar" style="width: 50%">
                            <span id="noPool">-- BNB</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Indicator -->
            <div class="live-indicator">
                <span class="live-dot"></span>
                <span id="updateText">Click "Connect Wallet" to start</span>
            </div>
        </div>

        <!-- Instructions -->
        <div class="info-box">
            <strong>🎮 How to Use This Demo:</strong><br>
            1. Click "Connect Wallet" (MetaMask/Rabby/WalletConnect)<br>
            2. Make sure you're on <strong>BSC Testnet</strong><br>
            3. Get free test BNB from the faucet<br>
            4. Enter bet amount (max 0.1 BNB)<br>
            5. Click YES or NO to place a bet<br>
            6. Watch the odds update in real-time!
        </div>
    </div>

    <script>
        // CONFIGURATION - UPDATE THESE ADDRESSES
        const CONFIG = {
            // BSC Testnet (for practice)
            testnet: {
                chainId: 97,
                chainName: 'BSC Testnet',
                rpcUrl: 'https://data-seed-prebsc-1-s1.binance.org:8545',
                marketAddress: '0x5173680ab1aC105bF07061FB302570d42D8338A0', // Your testnet market
                explorerUrl: 'https://testnet.bscscan.com'
            },
            // BSC Mainnet (for production)
            mainnet: {
                chainId: 56,
                chainName: 'BSC Mainnet',
                rpcUrl: 'https://bsc-dataseed1.binance.org',
                marketAddress: 'UPDATE_AFTER_MAINNET_DEPLOYMENT', // Update this!
                explorerUrl: 'https://bscscan.com'
            }
        };

        // Switch between testnet/mainnet
        const USE_TESTNET = true; // Set to false for mainnet
        const NETWORK = USE_TESTNET ? CONFIG.testnet : CONFIG.mainnet;

        // Contract ABI (minimal)
        const MARKET_ABI = [
            "function bet(bool yes) external payable",
            "function viewOdds() external view returns (uint256, uint256)",
            "function yesPool() external view returns (uint256)",
            "function noPool() external view returns (uint256)",
            "event Bet(address indexed user, bool yes, uint256 amount)"
        ];

        let provider = null;
        let signer = null;
        let userAddress = null;
        let contract = null;

        // Update mode text
        document.getElementById('modeText').textContent = USE_TESTNET 
            ? 'BSC Testnet (Safe to experiment!)' 
            : 'BSC Mainnet (Real money!)';

        // Connect Wallet
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                const btn = document.getElementById('connectBtn');
                btn.textContent = 'Connecting...';
                btn.disabled = true;

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);

                // Check/switch network
                const network = await provider.getNetwork();
                if (network.chainId !== NETWORK.chainId) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + NETWORK.chainId.toString(16) }],
                        });
                    } catch (error) {
                        alert(`Please switch to ${NETWORK.chainName} manually`);
                        btn.textContent = 'Connect Wallet';
                        btn.disabled = false;
                        return;
                    }
                }

                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(NETWORK.marketAddress, MARKET_ABI, signer);

                // Update UI
                document.getElementById('walletAddress').textContent = 
                    userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                
                const balance = await provider.getBalance(userAddress);
                document.getElementById('walletBalance').textContent = 
                    parseFloat(ethers.utils.formatEther(balance)).toFixed(4) + ' BNB';

                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('networkBadge').textContent = NETWORK.chainName;
                document.getElementById('networkBadge').style.background = '#2ecc71';
                
                btn.textContent = 'Connected ✓';
                
                // Enable betting buttons
                document.getElementById('betYesBtn').disabled = false;
                document.getElementById('betNoBtn').disabled = false;

                // Start fetching data
                fetchMarketData();
                setInterval(fetchMarketData, 3000); // Update every 3 seconds

                console.log('✅ Wallet connected:', userAddress);
                console.log('✅ Network:', NETWORK.chainName);
                console.log('✅ Market:', NETWORK.marketAddress);

            } catch (error) {
                console.error('Connection error:', error);
                alert('Failed to connect: ' + error.message);
                document.getElementById('connectBtn').textContent = 'Connect Wallet';
                document.getElementById('connectBtn').disabled = false;
            }
        }

        // Fetch Market Data
        async function fetchMarketData() {
            if (!contract) return;

            try {
                const readContract = new ethers.Contract(
                    NETWORK.marketAddress, 
                    MARKET_ABI, 
                    new ethers.providers.JsonRpcProvider(NETWORK.rpcUrl)
                );

                const [yesPool, noPool, odds] = await Promise.all([
                    readContract.yesPool(),
                    readContract.noPool(),
                    readContract.viewOdds()
                ]);

                const yesPoolBNB = parseFloat(ethers.utils.formatEther(yesPool));
                const noPoolBNB = parseFloat(ethers.utils.formatEther(noPool));
                const yesOdds = odds[0].toNumber() / 100;
                const noOdds = odds[1].toNumber() / 100;

                // Update UI
                document.getElementById('yesPercentage').textContent = Math.round(yesOdds) + '%';
                document.getElementById('yesLabel').textContent = Math.round(yesOdds) + '% Chance';
                document.getElementById('noLabel').textContent = Math.round(noOdds) + '% Chance';
                document.getElementById('yesBar').style.width = yesOdds + '%';
                document.getElementById('noBar').style.width = noOdds + '%';
                document.getElementById('yesPool').textContent = yesPoolBNB.toFixed(3) + ' BNB';
                document.getElementById('noPool').textContent = noPoolBNB.toFixed(3) + ' BNB';

                // Calculate payouts
                const betAmount = parseFloat(document.getElementById('betAmount').value || 0);
                const yesPayout = calculatePayout(betAmount, true, yesPool, noPool);
                const noPayout = calculatePayout(betAmount, false, yesPool, noPool);

                document.getElementById('yesPayout').textContent = 
                    `${betAmount} BNB → ${yesPayout.toFixed(3)} BNB`;
                document.getElementById('noPayout').textContent = 
                    `${betAmount} BNB → ${noPayout.toFixed(3)} BNB`;

                const now = new Date();
                document.getElementById('updateText').textContent = 
                    `Updated ${now.toLocaleTimeString()}`;

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Calculate Payout
        function calculatePayout(betAmount, betOnYes, yesPool, noPool) {
            if (betAmount === 0) return 0;

            const betWei = ethers.utils.parseEther(betAmount.toString());
            const winPool = betOnYes ? yesPool : noPool;
            const losePool = betOnYes ? noPool : yesPool;

            if (winPool.eq(0)) {
                return betAmount * 2;
            }

            const newWinPool = winPool.add(betWei);
            const grossPayout = betWei.add(losePool.mul(betWei).div(newWinPool));
            
            // 2% fee
            const profit = grossPayout.sub(betWei);
            const fee = profit.mul(200).div(10000);
            const netPayout = grossPayout.sub(fee);

            return parseFloat(ethers.utils.formatEther(netPayout));
        }

        // Place Bet
        async function placeBet(betYes) {
            if (!signer) {
                alert('Please connect your wallet first');
                return;
            }

            const betAmount = document.getElementById('betAmount').value;
            if (!betAmount || betAmount <= 0) {
                alert('Please enter a valid bet amount');
                return;
            }

            if (betAmount > 0.1) {
                alert('Maximum bet is 0.1 BNB per wallet');
                return;
            }

            try {
                const btn = betYes ? document.getElementById('betYesBtn') : document.getElementById('betNoBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="bet-label">Processing...</span>';
                btn.disabled = true;

                console.log(`Placing ${betAmount} BNB on ${betYes ? 'YES' : 'NO'}...`);

                const tx = await contract.bet(betYes, {
                    value: ethers.utils.parseEther(betAmount)
                });

                console.log('Transaction sent:', tx.hash);
                alert(`Transaction sent! Hash: ${tx.hash.slice(0, 10)}...`);

                const receipt = await tx.wait();
                console.log('✅ Bet confirmed!', receipt);

                alert(`✅ Bet placed successfully!\nView on ${NETWORK.chainName.includes('Test') ? 'Testnet ' : ''}BSCScan`);

                // Refresh data
                fetchMarketData();

                btn.innerHTML = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error('Bet failed:', error);
                
                let errorMsg = 'Transaction failed';
                if (error.message.includes('user rejected')) {
                    errorMsg = 'Transaction cancelled';
                } else if (error.message.includes('insufficient funds')) {
                    errorMsg = 'Insufficient BNB balance';
                }
                
                alert('❌ ' + errorMsg);
                
                const btn = betYes ? document.getElementById('betYesBtn') : document.getElementById('betNoBtn');
                btn.disabled = false;
                fetchMarketData();
            }
        }

        // Update payouts when bet amount changes
        document.getElementById('betAmount').addEventListener('input', () => {
            if (contract) fetchMarketData();
        });
    </script>
</body>
</html>

